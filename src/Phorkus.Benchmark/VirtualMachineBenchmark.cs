using System;
using Google.Protobuf;
using Phorkus.Core.Config;
using Phorkus.Core.DI;
using Phorkus.Core.DI.Modules;
using Phorkus.Core.DI.SimpleInjector;
using Phorkus.Core.VM;
using Phorkus.Proto;
using Phorkus.Storage.State;
using Phorkus.Utility;
using Phorkus.Utility.Utils;

namespace Phorkus.Benchmark
{
    public class VirtualMachineBenchmark : IBootstrapper
    {
        private readonly IContainer _container;

        public VirtualMachineBenchmark()
        {
            var containerBuilder = new SimpleInjectorContainerBuilder(
                new ConfigManager("config.json"));

            containerBuilder.RegisterModule<BlockchainModule>();
            containerBuilder.RegisterModule<ConfigModule>();
            containerBuilder.RegisterModule<CryptographyModule>();
            containerBuilder.RegisterModule<MessagingModule>();
            containerBuilder.RegisterModule<NetworkModule>();
            containerBuilder.RegisterModule<StorageModule>();

            _container = containerBuilder.Build();
        }

        public void Start(string[] args)
        {
            var virtualMachine = _container.Resolve<IVirtualMachine>();
            var stateManager = _container.Resolve<IStateManager>();

            var hash = UInt160Utils.Zero;
            var contract = new Contract
            {
                ContractAddress = hash,
                ByteCode = ByteString.CopyFrom(
                    "0061736d01000000011d0660027f7f017f60027f7f006000017f60037f7f7f0060017f0060000002ae010903656e760d6765745f63616c6c5f73697a65000203656e760f636f70795f63616c6c5f76616c7565000303656e760c6c6f61645f73746f72616765000103656e760a7365745f72657475726e000103656e760b73797374656d5f68616c74000403656e761063727970746f5f6b656363616b323536000303656e760b77726974655f6576656e74000303656e760a6765745f73656e646572000403656e760c736176655f73746f72616765000103090805000401040403010405017001030305030100020608017f0141f088040b071202066d656d6f7279020005737461727400090908010041010b020a0c0a963908e51a03037f047e027f23808080800041f0016b2200248080808000024002401080808080004104490d0041004104200041b0016a10818080800002400240024002400240024020002800b00122014185fafb1e4a0d00200141016a220241014d0d05200141a98bf0dc7b460d0120014198acb4e87d470d044100420037039888808000410042003703908880800041004200370388888080004100420037038088808000410042003703a888808000410042013703a088808000410042003703b088808000410042003703b888808000410042003703c888808000410042023703c088808000410042003703d088808000410042003703d888808000200041a0016a4200370300200041a8016a42003703002000420037039801200042013703900120004190016a200041b0016a10828080800020002903b001210320002903b801210420002903c0012105200020002903c80122064238883c003f200020064230883c003e200020064228883c003d200020064220883c003c200020064218883c003b200020064210883c003a200020064208883c0039200020063c0038200020054238883c0037200020054230883c0036200020054228883c0035200020054220883c0034200020054218883c0033200020054210883c0032200020054208883c0031200020053c0030200020044238883c002f200020044230883c002e200020044228883c002d200020044220883c002c200020044218883c002b200020044210883c002a200020044208883c0029200020043c0028200020034238883c0027200020034230883c0026200020034228883c0025200020034220883c0024200020034218883c0023200020034210883c0022200020034208883c0021200020033c0020200041206a41201083808080000c070b20014186fafb1e460d02200141c082bfc801460d01200141f0c08a8c03470d0302401080808080004118460d0041061084808080000b41044118200041206a1081808080004100420037038088808000410042013703a088808000410042003703a888808000410042023703c088808000410042003703c888808000410042003703d088808000410042003703d888808000410042003703b088808000410042003703b8888080004100420037038888808000410042003703908880800041004200370398888080002000290320210320002903282104200020002802303602682000200437036020002003370358200041b0016a41186a4200370300200041c0016a4200370300200042003703b801200042003703b001200041d8016a2000290360370300200041e0016a2000280268360200200020002903583703d001200041b0016a413420004190016a10858080800020004190016a20004190016a41201086808080002000290390012103200029039801210420002903a0012105200020002903a8013703a801200020053703a0012000200437039801200020033703900120004190016a200041b0016a10828080800020002903b001210320002903b801210420002903c0012105200020002903c80122064238883c00cf01200020064230883c00ce01200020064228883c00cd01200020064220883c00cc01200020064218883c00cb01200020064210883c00ca01200020064208883c00c901200020063c00c801200020054238883c00c701200020054230883c00c601200020054228883c00c501200020054220883c00c401200020054218883c00c301200020054210883c00c201200020054208883c00c101200020053c00c001200020044238883c00bf01200020044230883c00be01200020044228883c00bd01200020044220883c00bc01200020044218883c00bb01200020044210883c00ba01200020044208883c00b901200020043c00b801200020034238883c00b701200020034230883c00b601200020034228883c00b501200020034220883c00b401200020034218883c00b301200020034210883c00b201200020034208883c00b101200020033c00b001200041b0016a41201083808080000c060b418180808000108b808080000c050b418280808000108d808080000c040b410021024100420037038088808000410042003703888880800041004200370390888080004100420037039888808000410042003703a888808000410042013703a088808000410042003703b088808000410042003703b888808000410042003703c888808000410042023703c088808000410042003703d088808000410042003703d8888080000240024041002d00e8888080004101710d00410041003602e0888080003f002101410041013602e8888080004100200141016a3602e4888080000c010b41002802e0888080002202418a807c6a2201418080046d2107200141808004480d00200740001a410041002802e48880800020076a3602e48880800041002802e08880800021020b41002002410a6a418080046f22013602e08880800020004280808080a0013702b401200020023602b00141002d00e8888080004101712107024002402002450d0020070d0041002101410041003602e0888080003f002102410041013602e8888080004100200241016a3602e4888080000c010b024020070d0041002101410041003602e0888080003f002102410041013602e8888080004100200241016a3602e4888080000c010b20014185807c6a2202418080046d2107200241808004480d00200740001a410041002802e48880800020076a3602e48880800041002802e08880800021010b4100200141056a418080046f3602e088808000200141ce003a0004200020013602b001200141d49eadaa0436000020004285808080d0003702b401200041b0016a108e808080000c030b41051084808080000c020b024020020e020100010b02401080808080004124460d0041061084808080000b41044124200041206a108180808000410021014100420037038088808000410042003703888880800041004200370390888080004100420037039888808000410042003703a888808000410042013703a088808000410042003703b088808000410042003703b888808000410042003703c888808000410042023703c088808000410042003703d088808000410042003703d88880800020002903382103200029033021042000290328210520002903202106200041b0016a108780808000200020002d00b0013a0078200020002800b101360079200020002900b50137007d200020002800bd0136008501200020002f00c1013b008901200020002d00c3013a008b0120002006370358200020053703602000200437036820002003370370200041186a200028028801360200200041106a20002903800137030020002000290378370308200041086a200041d8006a108c80808000200041b0016a108780808000200020002d00b00122023a0040200020002800b101360041200020002900b501370045200020002800bd0136004d200020002f00c1013b0051200020002d00c3013a0053200041002903c08880800037039001200041002903c88880800037039801200041002903d0888080003703a001200041002903d8888080003703a8010240024041002d00e8888080004101710d00410041003602e0888080003f002107410041013602e8888080004100200741016a3602e4888080000c010b41002802e088808000220141a0807c6a2207418080046d2108200741808004480d00200840001a410041002802e48880800020086a3602e48880800041002802e08880800021010b4100200141206a418080046f3602e088808000200120023a0000200120002d00413a0001200120002d00423a0002200120002d00433a0003200120002d00443a0004200120002d00453a0005200120002d00463a0006200120002d00473a0007200120002d00483a0008200120002d00493a0009200120002d004a3a000a200120002d004b3a000b200120002d004c3a000c200120002d004d3a000d200120002d004e3a000e200120002d004f3a000f200120002d00503a0010200120002d00513a0011200120002d00523a0012200120002d00533a001320004190016a2001108880808000200041c8016a4200370300200041c0016a4200370300200041b8016a4200370300200042003703b0010240024002400240200029039001220342017c22042003540d00200020043703b00120002903980121030c010b200020043703b001200042013703b801200029039801220442017c220320045a0d00200020033703b801200042013703c00120002903a001220442017c220320045a0d01200020033703c001200042013703c80120002903a80142017c21030c020b200020033703b80120002903a00121030b200020033703c00120002903a80121030b20004190016a41186a200337030020004190016a41086a200041b0016a41086a220229030037030020004190016a41106a200041b0016a41106a2207290300370300200020002903b0013703900102402001450d0041002d00e8888080004101710d00410041003602e0888080003f002101410041013602e8888080004100200141016a3602e4888080000b200041b0016a41186a42003703002007420037030020024200370300200042003703b0012000419ed6f2d67b36029001200041b0016a20004190016a41041086808080000c010b41051084808080000b200041f0016a2480808080000bdc0a03017f077e017f23808080800041a0016b22022480808080004100420037039888808000410042003703908880800041004200370388888080004100420037038088808000410042003703a888808000410042013703a088808000410042003703b088808000410042003703b888808000410042003703c888808000410042023703c088808000410042003703d088808000410042003703d88880800020024180016a108780808000200220022d0080013a00482002200228008101360049200220022900850137004d2002200228008d01360055200220022f0091013b0059200220022d0093013a005b200241002903808880800037036020024100290388888080003703682002410029039088808000370370200241002903988880800037037820024180016a200241e0006a200241c8006a108f8080800020022903800121032002290388012104200229039001210520022002290398013703980120022005370390012002200437038801200220033703800120024180016a200241e0006a108280808000200220022903602203370328200220022903682206370330200220022903702205370338200220022903782204370340200421072001290318220821090240024020042008520d0020052107200520012903102209520d0020062107200620012903082209520d0020032107200320012903002209520d00200421080c010b200720095a0d00410410848080800020012903182108200229034021042002290338210520022903302106200229032821030b20042008427f857c20052001290310427f857c220820055420062001290308427f857c2204200654200320012903002207427f857c2209200354220a2004200aad7c2204507172220a2008200aad7c2206507172ad7c21084200210502400240200320077d22032009540d00200621070c010b0240200442017c22072004540d0020072104200621070c010b200642017c2207200654ad2105420021040b2002200737033820022004370330200220033703282002200820057c370340200241002903808880800037036020024100290388888080003703682002410029039088808000370370200241002903988880800037037820024180016a200241e0006a200241c8006a108f8080800020022903800121032002290388012104200229039001210520022002290398013703980120022005370390012002200437038801200220033703800120024180016a200241286a109080808000200241002903808880800037036020024100290388888080003703682002410029039088808000370370200241002903988880800037037820024180016a200241e0006a2000108f8080800020022903800121032002290388012104200229039001210520022002290398013703980120022005370390012002200437038801200220033703800120024180016a200241e0006a1082808080002002290378210420022903702105200229036821062001290308210320022001290300220820022903607c22073703082002200320067c22062007200854220aad7c220837031020022005200129031022077c22052006200354200a2008507172220aad7c22033703182002200420012903187c2005200754200a2003507172ad7c370320200241002903808880800037036020024100290388888080003703682002410029039088808000370370200241002903988880800037037820024180016a200241e0006a2000108f8080800020022903800121032002290388012104200229039001210520022002290398013703980120022005370390012002200437038801200220033703800120024180016a200241086a109080808000200241a0016a24808080800041010bea0102027f067e2380808080004190016b220124808080800002401080808080004138460d0041061084808080000b41044138200141206a108180808000200141186a20012802302202360200200141106a2001290328220337030020012001290320220437030820012903342105200129033c210620012903442107200129034c21082001200437037820012002360288012001200337038001200120083703702001200737036820012006370360200120053703582001200141086a200141d8006a2000118080808000003a008f012001418f016a410110838080800020014190016a2480808080000bd80803017f067e017f23808080800041c0016b22022480808080004100420037039888808000410042003703908880800041004200370388888080004100420037038088808000410042003703a888808000410042013703a088808000410042003703b088808000410042003703b888808000410042003703c888808000410042023703c088808000410042003703d088808000410042003703d88880800020024180016a41186a420037030020024180016a41106a420037030020024180016a41086a42003703002002420037038001200241a0016a20024180016a2000108f8080800020022903a001210320022903a801210420022903b0012105200220022903b8013703b801200220053703b001200220043703a801200220033703a001200241a0016a20024180016a108280808000200229039801210420022903900121052002290388012106200129030821032002200129030022072002290380017c22083703602002200320067c220620082007542209ad7c220737036820022005200129031022087c22052006200354200920075071722209ad7c22033703702002200420012903187c200520085420092003507172ad7c370378200241c0006a41186a4200370300200241c0006a41106a4200370300200241c0006a41086a420037030020024200370340200241002903808880800037038001200241002903888880800037038801200241002903908880800037039001200241002903988880800037039801200241a0016a20024180016a2000108f8080800020022903a001210320022903a801210420022903b0012105200220022903b8013703b801200220053703b001200220043703a801200220033703a001200241a0016a200241e0006a109080808000200241c0006a200241e0006a4120108680808000200241002903a0888080003703a001200241002903a8888080003703a801200241002903b0888080003703b001200241002903b8888080003703b801200241a0016a20024180016a108280808000200229039801210420022903900121052002290388012106200129030821032002200129030022072002290380017c22083703202002200320067c220620082007542200ad7c220737032820022005200129031022087c22052006200354200020075071722200ad7c22033703302002200420012903187c200520085420002003507172ad7c370338200241002903a0888080003703a001200241002903a8888080003703a801200241002903b0888080003703b001200241002903b8888080003703b801200241a0016a200241206a109080808000200241002903a0888080003703a001200241002903a8888080003703a801200241002903b0888080003703b001200241002903b8888080003703b801200241a0016a20024180016a1082808080002002200229038001370300200220022903880137030820022002290390013703102002200229039801370318200241c0006a20024120108680808000200241c0016a2480808080000bd60102027f067e2380808080004190016b220124808080800002401080808080004138460d0041061084808080000b41044138200141206a108180808000200141186a20012802302202360200200141106a2001290328220337030020012001290320220437030820012903342105200129033c210620012903442107200129034c2108200120043703782001200236028801200120033703800120012008370370200120073703682001200637036020012005370358200141086a200141d8006a20001181808080000020014190016a2480808080000b830301057f20002802042101410021020240024041002d00e888808000410171450d0041002802e08880800021020c010b410041003602e0888080003f002103410041013602e8888080004100200341016a3602e4888080000b200141046a2104200120026a4184807c6a2203418080046d21050240200341808004480d00200540001a410041002802e48880800020056a3602e4888080002000280204210141002802e08880800021020b410021034100200220046a418080046f3602e088808000200220014118763a0003200220014110763a0002200220014108763a0001200220013a00000240024002402000280204450d00034002402003417f4a0d0041021084808080000b200220036a41046a200028020020036a2d00003a0000200341016a22032000280204490d000b200220041083808080000c010b200220041083808080002002450d010b41002d00e8888080004101710d00410041003602e0888080003f002103410041013602e8888080004100200341016a3602e4888080000b0bc90101017f23808080800041e0006b2203248080808000200320012903003703202003200129030837032820032001290310370330200320012903183703382003200229000037034020032002280008360248200320022f000c3b014c200320022d000e3a004e200320022d000f3a004f20032002280010360250200341206a4134200310858080800020032003412010868080800020002003290318370318200020032903103703102000200329030837030820002003290300370300200341e0006a2480808080000be00202037f027e410021020240024041002d00e8888080004101710d00410041003602e0888080003f002103410041013602e8888080004100200341016a3602e4888080000c010b41002802e088808000220241a0807c6a2203418080046d2104200341808004480d00200440001a410041002802e48880800020046a3602e48880800041002802e08880800021020b4100200241206a418080046f3602e088808000200220012903003700002002200129030837000820022001290310370010200220012903183700182000200210888080800020002000290300220542017c22063703002000200029030820062005542201ad7c2205370308200020002903102001200550712201ad7c220537031020002000290318200120055071ad7c37031802402002450d0041002d00e8888080004101710d00410041003602e0888080003f002100410041013602e8888080004100200041016a3602e4888080000b0b0b7301004180080b6c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ad07046e616d6501a50711000d6765745f63616c6c5f73697a65010f636f70795f63616c6c5f76616c7565020c6c6f61645f73746f72616765030a7365745f72657475726e040b73797374656d5f68616c74051063727970746f5f6b656363616b323536060b77726974655f6576656e74070a6765745f73656e646572080c736176655f73746f72616765090573746172740a447472616e73666572286c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e2c206c61636861696e3a3a75696e74323536290bac01766f6964206c61636861696e3a3a696e766f6b655f636f6e74726163745f6d6574686f643c626f6f6c2c206c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e2c206c61636861696e3a3a75696e743235363e28626f6f6c20282a29286c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e2c206c61636861696e3a3a75696e7432353629290c406d696e74286c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e2c206c61636861696e3a3a75696e74323536290dac01766f6964206c61636861696e3a3a696e766f6b655f636f6e74726163745f6d6574686f643c766f69642c206c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e2c206c61636861696e3a3a75696e743235363e28766f696420282a29286c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e2c206c61636861696e3a3a75696e7432353629290e43766f6964206c61636861696e3a3a72657475726e5f76616c75653c6c61636861696e3a3a737472696e673e286c61636861696e3a3a737472696e6720636f6e737426290f93016c61636861696e3a3a75696e74323536206c61636861696e3a3a6b65795f616464726573733c6c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e203e286c61636861696e3a3a75696e743235362c206c61636861696e3a3a66697865645f61727261793c756e7369676e656420636861722c203230753e20636f6e73742629105a766f6964206c61636861696e3a3a736176655f746f5f73746f726167653c6c61636861696e3a3a75696e743235363e286c61636861696e3a3a75696e743235362c206c61636861696e3a3a75696e7432353620636f6e7374262900750970726f647563657273010c70726f6365737365642d62790105636c616e6755392e302e31202868747470733a2f2f6769746875622e636f6d2f6c6c766d2f6c6c766d2d70726f6a656374206331613061323133333738613435386662656131613563373762333135633764636530386664303529"
                        .HexToBytes())
            };
            if (!virtualMachine.VerifyContract(contract.ByteCode.ToByteArray()))
                throw new Exception("Unable to validate smart-contract code");

            var snapshot = stateManager.NewSnapshot();
            snapshot.Contracts.AddContract(UInt160Utils.Zero, contract);
            stateManager.Approve();

            Console.WriteLine("Contract Hash: " + hash.Buffer.ToHex());

            for (var i = 0; i < 1; ++i)
            {
                var currentTime = TimeUtils.CurrentTimeMillis();
                stateManager.NewSnapshot();

                var sender = "0x6bc32575acb8754886dc283c2c8ac54b1bd93195".HexToBytes().ToUInt160();
                var to = "0xfd893ce89186fc6861d339cb6ab5d75458e3daf3".HexToBytes().ToUInt160();

                /* give to sender 1 token */
                var valueToTransfer = Money.Wei;
                stateManager.CurrentSnapshot.Storage.SetValue(contract.ContractAddress, sender.ToUInt256(),
                    (valueToTransfer * 3).ToUInt256());
                var context = new InvocationContext(sender);

                {
                    /* ERC-20: totalSupply (0x18160ddd) */
                    Console.WriteLine("\nERC-20: totalSupply()");
                    var input = ContractEncoder.Encode("totalSupply()");
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        return;
                    }    
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                {
                    /* mint */
                    Console.WriteLine($"\nERC-20: mint({sender.Buffer.ToHex()},{Money.FromDecimal(100)})");
                    var input = ContractEncoder.Encode("mint(address,uint256)", sender, Money.FromDecimal(100));
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        goto exit_mark;
                    }
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                {
                    /* ERC-20: totalSupply (0x18160ddd) */
                    Console.WriteLine("\nERC-20: totalSupply()");
                    var input = ContractEncoder.Encode("totalSupply()");
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        goto exit_mark;
                    }                    
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({sender.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", sender);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        goto exit_mark;
                    }                    
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                {
                    /* ERC-20: transfer */
                    Console.WriteLine($"\nERC-20: transfer({to.ToHex()},{Money.FromDecimal(50)})");
                    var input = ContractEncoder.Encode("transfer(address,uint256)", to, Money.FromDecimal(50));
                    Console.WriteLine($"ABI: {input.ToHex()}");
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        goto exit_mark;
                    }
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({sender.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", sender);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        goto exit_mark;
                    }                    
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({to.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", to);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = virtualMachine.InvokeContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status);
                        goto exit_mark;
                    }                    
                    Console.WriteLine($"Result: {status.ReturnValue.ToHex()}");
                }
                
                stateManager.Approve();
                exit_mark:
                var elapsedTime = TimeUtils.CurrentTimeMillis() - currentTime;
                Console.WriteLine("Elapsed Time: " + elapsedTime + "ms");
            }
        }
    }
}