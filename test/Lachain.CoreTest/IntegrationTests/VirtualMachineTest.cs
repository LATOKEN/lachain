using System;
using System.IO;
using System.Reflection;
using Lachain.Core.Blockchain.VM;
using Lachain.Core.CLI;
using Lachain.Core.Config;
using Lachain.Core.DI;
using Lachain.Core.DI.Modules;
using Lachain.Core.DI.SimpleInjector;
using Lachain.Proto;
using Lachain.Storage.State;
using Lachain.Utility;
using Lachain.Utility.Utils;
using Lachain.UtilityTest;
using NUnit.Framework;

namespace Lachain.CoreTest.IntegrationTests
{
    public class VirtualMachineTest
    {
        private IContainer _container;

        [SetUp]
        public void Setup()
        {
            TestUtils.DeleteTestChainData();

            var containerBuilder = new SimpleInjectorContainerBuilder(new ConfigManager(
                Path.Join(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), "config.json"),
                new RunOptions()
            ));

            containerBuilder.RegisterModule<BlockchainModule>();
            containerBuilder.RegisterModule<ConfigModule>();
            containerBuilder.RegisterModule<StorageModule>();

            _container = containerBuilder.Build();
        }

        [TearDown]
        public void Teardown()
        {
            _container.Dispose();

            TestUtils.DeleteTestChainData();
        }

        [Test]
        public void Test_VirtualMachine_InvokeContract()
        {
            var stateManager = _container.Resolve<IStateManager>();

            var hash = UInt160Utils.Zero;
            var contract = new Contract
            (
                hash,
                "0061736D0100000001720E60027F7F0060017F006000017F60037F7F7F0060000060017F017F60037F7F7F017F60047F7F7F7F017F60077E7E7E7E7E7E7E017F600A7E7E7E7E7E7E7E7E7E7E017F60047E7E7E7F017F60087E7E7E7E7E7E7E7F017F600B7E7E7E7E7E7E7E7E7E7E7F017F60077E7E7E7E7E7E7F017F02B1010903656E760C6C6F61645F73746F72616765000003656E760A7365745F72657475726E000003656E760B73797374656D5F68616C74000103656E760C736176655F73746F72616765000003656E760977726974655F6C6F67000003656E760A6765745F73656E646572000103656E76156765745F7472616E736665727265645F66756E6473000103656E760D6765745F63616C6C5F73697A65000203656E760F636F70795F63616C6C5F76616C75650003031514030004050303030601070808090A0B0B0C090D040405017001010105030100020608017F01418080040B071202066D656D6F72790200057374617274001C0AE667142E0002402002450D000340200020012D00003A0000200041016A2100200141016A21012002417F6A22020D000B0B0B1C00034020004200370300200041086A21002001417F6A22010D000B0B2E004100410036028080044100410036028480044100410036028C800441003F0041107441F0FF7B6A36028880040BA60101047F418080042101024003400240200128020C0D002001280208220220004F0D020B200128020022010D000B41002101410028020821020B02402002200041076A41787122036B22024118490D00200120036A41106A22002001280200220436020002402004450D00200420003602040B2000200241706A3602082000410036020C2000200136020420012000360200200120033602080B2001410136020C200141106A0B2D002000411F6A21000340200120002D00003A0000200141016A21012000417F6A21002002417F6A22020D000B0B2D002001411F6A21010340200120002D00003A00002001417F6A2101200041016A21002002417F6A22020D000B0B29002001417F6A21010340200120026A20002D00003A0000200041016A21002002417F6A22020D000B0B7E01017F200120006C220141086A100C2203200036020420032000360200200341086A2100024002402002417F460D002001450D010340200020022D00003A0000200041016A2100200241016A21022001417F6A22010D000C020B0B2001450D000340200041003A0000200041016A21002001417F6A22010D000B0B20030BF30904117E017F067E027F20002903702101200029034821022000290368210320002903602104200029038001210520002903582106200029037821072000290350210820002903C0012109200029039801210A20002903B801210B200029039001210C20002903B001210D200029038801210E20002903A801210F20002903A0012110200029030021114100211203402000200029033022132000290308221485200685200585200F85220F42018920022000290320221585200185200A8520098522098522162010853703A0012000201620078537037820002016200885370350200020162000290328220A85370328200020162011853703002000200029033822172000290310221885200485200E85200D85220D420189200A20118520088520078520108522078522102005853703800120002010200685370358200020102013853703302000201020148522163703082000201020002903A801853703A8012000200029034022052000290318220685200385200C85200B852208420189200F85221020048537036020002010201785370338200020102018853703102000201020002903880185370388012000201020002903B001853703B00120002009420189200D85221020038537036820002010200585370340200020102006853703182000201020002903900185370390012000201020002903B801853703B80120002007420189200885221020018537037020002010200285370348200020102015853703202000201020002903980185370398012000201020002903C001853703C00141A07F211903402000201941A0026A2802004103746A221A2903002110201A201620194180036A3502008937030020102116201941046A22190D000B2000200029032022162000290308221020002903002201427F85838537032020002000290318220220012016427F85838537031820002000290310220320162002427F8583853703102000201020022003427F8583853703082000200120032010427F8583853703002000200029032822162000290338221020002903302201427F85838537032820002001200029034022022010427F85838537033020002010200029034822032002427F8583853703382000200220162003427F8583853703402000200320012016427F858385220237034820002903602116200029036821102000200029037022042000290358220520002903502207427F85838522013703702000201020072004427F85838522033703682000201620042010427F85838522043703602000200520102016427F85838522063703582000200720162005427F85838522083703502000290388012116200029039001211020002000290398012205200029038001220720002903782211427F858385220A370398012000201020112005427F858385220C370390012000201620052010427F858385220E370388012000200720102016427F8583852205370380012000201120162007427F858385220737037820002903B001211620002903B8012110200020002903C001221120002903A801221320002903A0012214427F85838522093703C0012000201020142011427F858385220B3703B8012000201620112010427F858385220D3703B0012000201320102016427F858385220F3703A8012000201420162013427F85838522103703A00120002000290300201241037441006A290300852211370300201241016A22124118470D000B0BC90301027F230041E0016B22042400200442003703C801200442003703C001200442003703B801200442003703B001200442003703A801200442003703A0012004420037039801200442003703900120044200370388012004420037038001200442003703782004420037037020044200370368200442003703602004420037035820044200370350200442003703482004420037034020044200370338200442003703302004420037032820044200370320200442003703182004420037031020044200370308200420033602D80141002105200441003602D001200441C80120034101746B3602D40102402001450D00410021050340200441086A20056A220320032D000020002D0000733A00000240200541016A220520042802D401480D00200441086A1011410021050B200041016A21002001417F6A22010D000B0B200420053602D001200441086A20056A220520052D00004106733A000020042802D401200441086A6A417F6A220520052D0000418001733A0000200441086A1011024020042802D80122014101480D00200441086A2105200221000340200020052D00003A0000200541016A2105200041016A21002001417F6A22010D000B0B200441E0016A240020020B810A04047F047E027F047E2300220721080240024002402000200242FFFFFFFF0F8384200184500D004101450D01200741406A220722092400200741286A2001370300200741206A2000370300200741306A20023E0200200741186A4200370300200742003703102007420037030820074200370300200941606A2209220A2400200741382009412010121A2009290300210B200941086A290300210C200941106A290300210D200941186A290300210E200A41606A220722092400200741186A200E3703002007200D3703102007200C3703082007200B370300200941606A2209220A24002007200910002009290300220E20035A200941086A290300220B20045A200B200451220F1B200941106A290300220C20055A200941186A290300220D20065A200D2006511B200C200585200D20068584501B0D024122410141B00310102209280200413F6A41607141246A2208100C220741A0F38DC600360200200741046A220F2008410376100A200A41706A220A22102400200A4120360200200A200F4104100E2009280200210A201041706A220F2400200F200A360200200F200741246A4104100E200741C4006A200941086A200A100920072008100141011002000B4121410141800310102208280200413F6A41607141246A220A100C220941A0F38DC600360200200941046A220F200A410376100A200741706A220722102400200741203602002007200F4104100E20082802002107201041706A220F2400200F2007360200200F200941246A4104100E200941C4006A200841086A200710092009200A100141011002000B2008240041000F0B200A41406A220722092400200741286A2001370300200741206A2000370300200741306A20023E0200200741186A4200370300200742003703102007420037030820074200370300200941606A2209220A2400200741382009412010121A20092903002111200941086A2903002112200941106A2903002113200941186A2903002114200A41606A220722092400200741186A2014370300200720133703102007201237030820072011370300200941606A2209220A2400200941186A200D20067D200C200554AD7D200C20057D220C200E2003542210200B200454200F1BAD220D54AD7D3703002009200C200D7D3703102009200B20047D2010AD7D3703082009200E20037D370300200720091003200A41606A220722092400200741186A4200370300200742003703102007420037030820074202370300200941606A2209220A2400200720091000200941186A290300210E200941106A290300210C2009290300210D200941086A290300210B200A41606A220722092400200741186A4200370300200742003703102007420037030820074202370300200941606A2209220A2400200941186A200E20067D200C200554AD7D200C20057D220C200D200354220F200B200454200B2004511BAD220E54AD7D3703002009200C200E7D3703102009200B20047D200FAD7D3703082009200D20037D3703002007200910034120100C22094104100A200A41606A2207220A2400200741186A2006370300200720053703102007200437030820072003370300200720094120100E4120100C220F4104100A200A41606A2207220A24002007200137030820072000370300200720023E02102007200F4114100E4120100C220F4104100A200A41606A220724002007420037030820074200370300200742003E02102007200F4114100E2009412010042008240041000BD10802067F087E230022072108024002402000200242FFFFFFFF0F8384200184500D0041010D012008240041000F0B411F410141E00310102208280200413F6A41607141246A2209100C220A41A0F38DC600360200200A41046A220B2009410376100A200741706A2207220C2400200741203602002007200B4104100E20082802002107200C41706A220B2400200B2007360200200B200A41246A4104100E200A41C4006A200841086A20071009200A2009100141011002000B200741606A2207220A2400200741186A4200370300200742003703102007420037030820074202370300200A41606A220A220924002007200A1000200A41186A290300210D200A41106A290300210E200A41086A290300210F200A2903002110200941606A2207220A2400200741186A4200370300200742003703102007420037030820074202370300200A41606A220A22092400200A41186A200D20067C200E20057C220D200E54AD7C200D201020037C2211201054220B200F20047C200BAD7C220E200F54200E200F511BAD7C220F200D54AD7C370300200A200F370310200A200E370308200A20113703002007200A1003200941406A2207220A2400200741286A2001370300200741206A2000370300200741306A20023E0200200741186A4200370300200742003703102007420037030820074200370300200A41606A220A2209240020074138200A412010121A200A290300210F200A41086A290300210E200A41106A2903002110200A41186A290300210D200941606A2207220A2400200741186A200D370300200720103703102007200E3703082007200F370300200A41606A220A220924002007200A1000200A41186A290300210D200A41106A290300210E200A41086A290300210F200A2903002110200941406A2207220A2400200741286A2001370300200741206A2000370300200741306A20023E0200200741186A4200370300200742003703102007420037030820074200370300200A41606A220A2209240020074138200A412010121A200A2903002111200A41086A2903002112200A41106A2903002113200A41186A2903002114200941606A2207220A2400200741186A2014370300200720133703102007201237030820072011370300200A41606A220A22092400200A41186A200D20067C200E20057C220D200E54AD7C200D201020037C2211201054220B200F20047C200BAD7C220E200F54200E200F511BAD7C220F200D54AD7C370300200A200F370310200A200E370308200A20113703002007200A10034120100C220A4104100A200941606A220722092400200741186A20063703002007200537031020072004370308200720033703002007200A4120100E4120100C220B4104100A200941606A2207220924002007420037030820074200370300200742003E02102007200B4114100E4120100C220B4104100A200941606A220724002007200137030820072000370300200720023E02102007200B4114100E200A412010042008240041000BD60602067F047E2300220A210B024002402000200242FFFFFFFF0F8384200184500D002003200542FFFFFFFF0F83842004844200520D014122410141B0041010220B280200413F6A41607141246A220C100C220D41A0F38DC600360200200D41046A220E200C410376100A200A41706A220A220F2400200A4120360200200A200E4104100E200B280200210A200F41706A220E2400200E200A360200200E200D41246A4104100E200D41C4006A200B41086A200A1009200D200C100141011002000B412441014180041010220B280200413F6A41607141246A220C100C220D41A0F38DC600360200200D41046A220E200C410376100A200A41706A220A220F2400200A4120360200200A200E4104100E200B280200210A200F41706A220E2400200E200A360200200E200D41246A4104100E200D41C4006A200B41086A200A1009200D200C100141011002000B200A41406A220A220D2400200A41286A2001370300200A41206A2000370300200A41306A20023E0200200A41186A4200370300200A4200370310200A4200370308200A4201370300200D41606A220D220C2400200A4138200D412010121A200D2903002110200D41086A2903002111200D41106A2903002112200D41186A2903002113200C41406A220A220D2400200A41286A2004370300200A41206A2003370300200A41306A20053E0200200A41186A2013370300200A2012370310200A2011370308200A2010370300200D41606A220D220C2400200A4138200D412010121A200D2903002110200D41086A2903002111200D41106A2903002112200D41186A2903002113200C41606A220A220D2400200A41186A2013370300200A2012370310200A2011370308200A2010370300200D41606A220D220C2400200D41186A2009370300200D2008370310200D2007370308200D2006370300200A200D10034120100C220D4104100A200C41606A220A220C2400200A41186A2009370300200A2008370310200A2007370308200A2006370300200A200D4120100E4120100C220E4104100A200C41606A220A220C2400200A2001370308200A2000370300200A20023E0210200A200E4114100E4120100C220E4104100A200C41606A220A2400200A2004370308200A2003370300200A20053E0210200A200E4114100E200D41201004200B240041000BEF0101027F230041E0006B22042400200441406A22052400200541286A2001370300200541206A2000370300200541306A20023E0200200541186A4200370300200542003703102005420037030820054200370300200541382004220441C0006A412010121A200441206A41186A200441C0006A41186A2903003703002004200441C0006A41106A2903003703302004200441C0006A41086A29030037032820042004290340370320200441206A20041000200341186A200441186A2903003703002003200441106A2903003703102003200441086A29030037030820032004290300370300200441E0006A240041000B9F0504047F037E017F047E230041306B220824002008220941186A10052009200941186A41086A220A290300370308200920092903183703002009200941186A41106A220B3502003E021002400240024041000D00200941086A290300210C200941106A350200210D2009290300210E200841606A2208220F2400200941186A10052008200A290300370308200820092903183703002008200B3502003E02104101450D01200841106A3502002110200841086A290300211120082903002112200F41406A2208220A2400200841286A2011370300200841206A2012370300200841306A20103E0200200841186A4200370300200842003703102008420037030820084201370300200A41606A220A220B240020084138200A412010121A200A2903002110200A41086A2903002111200A41106A2903002112200A41186A2903002113200B41406A2208220A2400200841286A2001370300200841206A2000370300200841306A20023E0200200841186A2013370300200820123703102008201137030820082010370300200A41606A220A220B240020084138200A412010121A200A2903002110200A41086A2903002111200A41106A2903002112200A41186A2903002113200B41606A2208220A2400200841186A2013370300200820123703102008201137030820082010370300200A41606A220A24002008200A1000200E200C200D200020012002200A290300221020037C2211200A41086A290300220320047C20112010542208AD7C2204200A41106A290300221020057C22052008200420035420042003511BAD7C2203200A41186A29030020067C2005201054AD7C2003200554AD7C10152208450D02200941306A240020080F0B200941306A240041000F0B200941306A240041000F0B200741013A0000200941306A240041000BD70605027F037E027F017E017F230041306B220824002008220941186A10052009200941186A41086A290300370308200920092903183703002009200941186A41106A3502003E0210024002400240024041000D00200941106A350200210A200941086A290300210B2009290300210C200841406A2208220D2400200841286A200B370300200841206A200C370300200841306A200A3E0200200841186A4200370300200842003703102008420037030820084201370300200D41606A220D220E240020084138200D412010121A200D290300210A200D41086A290300210B200D41106A290300210C200D41186A290300210F200E41406A2208220D2400200841286A2001370300200841206A2000370300200841306A20023E0200200841186A200F3703002008200C3703102008200B3703082008200A370300200D41606A220D220E240020084138200D412010121A200D290300210A200D41086A290300210B200D41106A290300210C200D41186A290300210F200E41606A2208220D2400200841186A200F3703002008200C3703102008200B3703082008200A370300200D41606A220D220E24002008200D1000200D290300220F20035A200D41086A290300220B20045A200B20045122101B200D41106A290300220C20055A200D41186A290300220A20065A200A2006511B200C200585200A20068584501B450D01200E41606A22082400200941186A10052008200941186A41086A290300370308200820092903183703002008200941186A41106A3502003E02104101450D022008290300200841086A290300200841106A350200200020012002200F20037D200B20047D200F2003542208AD7D200C20057D22032008200B20045420101BAD22047D200A20067D200C200554AD7D2003200454AD7D10152208450D03200941306A240020080F0B200941306A240041000F0B4125410141E00410102208280200413F6A41607141246A220D100C220941A0F38DC600360200200941046A2210200D410376100A200E41706A2207220E240020074120360200200720104104100E20082802002107200E41706A220E2400200E2007360200200E200941246A4104100E200941C4006A200841086A200710092009200D100141011002000B200941306A240041000F0B200741013A0000200941306A240041000B880703047F047E017F230041206B220B210C200B2400024002400240024002402000200120022003200420052006200720082009101A220D0D00200B41606A220B220D2400200C41086A1005200B200C41086A41086A290300370308200B200C290308370300200B200C41086A41106A3502003E02104101450D01200B41106A3502002103200B41086A2903002104200B2903002105200D41406A220B220D2400200B41286A2001370300200B41206A2000370300200B41306A20023E0200200B41186A4200370300200B4200370310200B4200370308200B4201370300200D41606A220D220E2400200B4138200D412010121A200D290300210F200D41086A2903002110200D41106A2903002111200D41186A2903002112200E41406A220B220D2400200B41286A2004370300200B41206A2005370300200B41306A20033E0200200B41186A2012370300200B2011370310200B2010370308200B200F370300200D41606A220D220E2400200B4138200D412010121A200D2903002103200D41086A2903002104200D41106A2903002105200D41186A290300210F200E41606A220B220D2400200B41186A200F370300200B2005370310200B2004370308200B2003370300200D41606A220D220E2400200B200D1000200D290300220F20065A200D41086A290300220420075A200420075122131B200D41106A290300220520085A200D41186A290300220320095A20032009511B2005200885200320098584501B450D02200E41606A220B2400200C41086A1005200B200C41086A41086A290300370308200B200C290308370300200B200C41086A41106A3502003E02104101450D03200020012002200B290300200B41086A290300200B41106A350200200F20067D200420077D200F200654220BAD7D200520087D2206200B200420075420131BAD22077D200320097D2005200854AD7D2006200754AD7D1015220B450D04200C41206A2400200B0F0B200C41206A2400200D0F0B200C41206A240041000F0B412841014190051010220B280200413F6A41607141246A220D100C220C41A0F38DC600360200200C41046A2213200D410376100A200E41706A220A220E2400200A4120360200200A20134104100E200B280200210A200E41706A220E2400200E200A360200200E200C41246A4104100E200C41C4006A200B41086A200A1009200C200D100141011002000B200C41206A240041000F0B200A41013A0000200C41206A240041000BAC0D04047F047E027F047E2300220A210B02400240024002402000200242FFFFFFFF0F8384200184500D002003200542FFFFFFFF0F83842004844200510D014101450D02200A41406A220A220C2400200A41286A2001370300200A41206A2000370300200A41306A20023E0200200A41186A4200370300200A4200370310200A4200370308200A4200370300200C41606A220C220D2400200A4138200C412010121A200C290300210E200C41086A290300210F200C41106A2903002110200C41186A2903002111200D41606A220A220C2400200A41186A2011370300200A2010370310200A200F370308200A200E370300200C41606A220C220D2400200A200C1000200C290300221120065A200C41086A290300220E20075A200E20075122121B200C41106A290300220F20085A200C41186A290300221020095A20102009511B200F200885201020098584501B0D034126410141A0061010220C280200413F6A41607141246A220B100C220A41A0F38DC600360200200A41046A2212200B410376100A200D41706A220D22132400200D4120360200200D20124104100E200C280200210D201341706A221224002012200D3602002012200A41246A4104100E200A41C4006A200C41086A200D1009200A200B100141011002000B4125410141C0051010220B280200413F6A41607141246A220D100C220C41A0F38DC600360200200C41046A2212200D410376100A200A41706A220A22132400200A4120360200200A20124104100E200B280200210A201341706A221224002012200A3602002012200C41246A4104100E200C41C4006A200B41086A200A1009200C200D100141011002000B4123410141F0051010220B280200413F6A41607141246A220D100C220C41A0F38DC600360200200C41046A2212200D410376100A200A41706A220A22132400200A4120360200200A20124104100E200B280200210A201341706A221224002012200A3602002012200C41246A4104100E200C41C4006A200B41086A200A1009200C200D100141011002000B200B240041000F0B200D41406A220A220C2400200A41286A2001370300200A41206A2000370300200A41306A20023E0200200A41186A4200370300200A4200370310200A4200370308200A4200370300200C41606A220C220D2400200A4138200C412010121A200C2903002114200C41086A2903002115200C41106A2903002116200C41186A2903002117200D41606A220A220C2400200A41186A2017370300200A2016370310200A2015370308200A2014370300200C41606A220C220D2400200C41186A201020097D200F200854AD7D200F20087D220F20112006542213200E20075420121BAD221054AD7D370300200C200F20107D370310200C200E20077D2013AD7D370308200C201120067D370300200A200C1003200D41406A220A220C2400200A41286A2004370300200A41206A2003370300200A41306A20053E0200200A41186A4200370300200A4200370310200A4200370308200A4200370300200C41606A220C220D2400200A4138200C412010121A200C290300210E200C41086A290300210F200C41106A2903002110200C41186A2903002111200D41606A220A220C2400200A41186A2011370300200A2010370310200A200F370308200A200E370300200C41606A220C220D2400200A200C1000200C41186A2903002111200C41106A290300210F200C41086A290300210E200C2903002110200D41406A220A220C2400200A41286A2004370300200A41206A2003370300200A41306A20053E0200200A41186A4200370300200A4200370310200A4200370308200A4200370300200C41606A220C220D2400200A4138200C412010121A200C2903002114200C41086A2903002115200C41106A2903002116200C41186A2903002117200D41606A220A220C2400200A41186A2017370300200A2016370310200A2015370308200A2014370300200C41606A220C220D2400200C41186A201120097C200F20087C2211200F54AD7C2011201020067C22142010542212200E20077C2012AD7C220F200E54200F200E511BAD7C220E201154AD7C370300200C200E370310200C200F370308200C2014370300200A200C10034120100C220C4104100A200D41606A220A220D2400200A41186A2009370300200A2008370310200A2007370308200A2006370300200A200C4120100E4120100C22124104100A200D41606A220A220D2400200A2001370308200A2000370300200A20023E0210200A20124114100E4120100C22124104100A200D41606A220A2400200A2004370308200A2003370300200A20053E0210200A20124114100E200C41201004200B240041000BF90202037F017E23004180016B22072400200741406A220822092400200841286A2001370300200841206A2000370300200841306A20023E0200200841186A4200370300200842003703102008420037030820084201370300200841382007220741E0006A412010121A200741E0006A41086A2903002102200741E0006A41106A2903002100200741E0006A41186A29030021012007290360210A200941406A22082400200841286A2004370300200841206A2003370300200841306A20053E0200200841186A200137030020082000370310200820023703082008200A37030020084138200741C0006A412010121A200741206A41186A200741C0006A41186A2903003703002007200741C0006A41106A2903003703302007200741C0006A41086A29030037032820072007290340370320200741206A20071000200641186A200741186A2903003703002006200741106A2903003703102006200741086A2903003703082006200729030037030020074180016A240041000BAF1702047F0A7E23004190066B22002400200041086A10060240024002400240024002400240024002400240024002400240024002400240024002400240024002400240024002400240024002400240024002402000290308200041106A290300844200520D00100B4100100722013602CC0641002001100C22023602D00641002001200210080240024002400240024002400240024002400240024002400240200141034D0D004100200228020022033602C8062001417C6A2101200241046A2102024020034185FAFB1E4A0D000240200341A3AF89BE7D4A0D002003419D85FFE47A460D0420034189BC9D9D7B460D05200341A98BF0DC7B470D0220014120490D1F200220004188036A4118100D2001AD423F580D0920004188036A41106A350200210420004188036A41086A29030021052000290388032106200241206A200041A0036A4120100D200041A0036A41186A2903002107200041A0036A41106A2903002108200041A0036A41086A290300210920002903A003210A200041F0056A10052000200041F0056A41086A290300220B3703D805200020002903F005220C3703D0052000200041F0056A41106A350200220D3E02E005200C200B200D200620052004200A200920082007101A22010D0A200041013A00C70341000D0B0C2C0B200341A4AF89BE7D460D0B200341A3F0CAEB7D460D0C20034198ACB4E87D470D01200041F0056A41186A42003703002000420037038006200042003703F805200042023703F005200041F0056A200041D0056A1000200041A8016A41186A200041D0056A41186A2903003703002000200041E0056A2903003703B8012000200041D8056A2903003703B001200020002903D0053703A8014100450D1641004100100141011002000B0240200341DCC5B5F7034A0D00200341C082BFC801460D02200341F0C08A8C03460D0520034186FAFB1E470D01200041F0056A41186A42003703002000420037038006200042003703F805200042033703F005200041F0056A200041D0056A1000200041186A41186A200041D0056A41186A2903003703002000200041E0056A2903003703282000200041D8056A290300370320200020002903D0053703184100450D0F41004100100141011002000B0240200341B8A0CD8C054A0D00200341DDC5B5F703460D0D20034195B1EF8C04470D01200041F0056A41186A42003703002000420037038006200042003703F805200042043703F005200041F0056A200041D0056A1000200041E0046A41186A200041D0056A41186A2903003703002000200041E0056A2903003703F0042000200041D8056A2903003703E804200020002903D0053703E0044100450D2641004100100141011002000B200341B9A0CD8C05460D06200341B1F894BF06460D050B41004100100141011002000B20014120490D0D2002200041386A4118100D2001AD423F580D0E200041386A41106A3502002104200041386A41086A290300210520002903382106200241206A200041D0006A4120100D4100210102402006200520042000290350200041D0006A41086A290300200041D0006A41106A290300200041D0006A41186A29030010142200450D00200021010B2001450D0F41004100100141011002000B20014120490D0F2002200041F0006A4118100D2001AD423F580D10200041F0006A41106A3502002104200041F0006A41086A290300210520002903702106200241206A20004188016A4120100D41002101024020062005200420002903880120004188016A41086A29030020004188016A41106A29030020004188016A41186A29030010132200450D00200021010B2001450D1141004100100141011002000B20014120490D122002200041C8016A4118100D0240024002402001AD423F580D00200041C8016A41106A3502002104200041C8016A41086A290300210520002903C8012106200241206A200041E0016A4120100D200041E0016A41186A2903002107200041E0016A41106A2903002108200041E0016A41086A290300210920002903E001210A200041F0056A10052000200041F0056A41086A290300220B3703D805200020002903F005220C3703D0052000200041F0056A41106A350200220D3E02E005200C200B200D200620052004200A200920082007101522010D01200041013A00870241000D020C280B20004190066A240041030F0B2001450D260B41004100100141011002000B20014120490D12200220004188026A4118100D20002903880220004190026A29030020004198026A350200200041A0026A1016450D1341004100100141011002000B200041123A00C7024100450D1341004100100141011002000B20014120490D132002200041C8026A4118100D2001AD423F580D14200041C8026A41106A3502002104200041C8026A41086A290300210520002903C8022106200241206A200041E0026A4120100D20062005200420002903E002200041E0026A41086A290300200041E0026A41106A290300200041E0026A41186A29030020004187036A1017450D1541004100100141011002000B20004190066A240041030F0B2001450D210B41004100100141011002000B20014120490D132002200041C8036A4118100D2001AD423F580D14200041C8036A41106A3502002104200041C8036A41086A290300210520002903C8032106200241206A200041E0036A4120100D20062005200420002903E003200041E0036A41086A290300200041E0036A41106A290300200041E0036A41186A29030020004187046A1018450D1541004100100141011002000B20014120490D15200220004188046A4118100D2001AD2204423F580D1620004188046A41106A350200210520004188046A41086A29030021062000290388042107200241206A200041A0046A4118100D200442DF00580D17200041A0046A41106A3502002104200041A0046A41086A290300210820002903A0042109200241C0006A200041B8046A4120100D20072006200520092008200420002903B804200041C0046A290300200041C8046A290300200041D0046A290300200041DF046A1019450D1841004100100141011002000B20014120490D19200220004180056A4118100D2001AD423F580D1A20004180056A41106A350200210420004180056A41086A29030021052000290380052106200241206A20004198056A4118100D20062005200420002903980520004198056A41086A29030020004198056A41106A350200200041B0056A101B450D1B41004100100141011002000B41004100100141011002000B4120100C22014104100A200041186A20014120100F20014120100141001002000B20004190066A240041030F0B20004190066A240041030F0B41004100100141001002000B20004190066A240041030F0B20004190066A240041030F0B41004100100141001002000B4120100C22014104100A200041A8016A20014120100E20014120100141001002000B20004190066A240041030F0B20004190066A240041030F0B4120100C22014104100A200041A0026A20014120100E20014120100141001002000B4120100C22014104100A2001411F6A20002D00C7023A000020014120100141001002000B20004190066A240041030F0B20004190066A240041030F0B4120100C22014104100A2001411F6A20002D0087033A000020014120100141001002000B20004190066A240041030F0B20004190066A240041030F0B20004190066A240041030F0B4120100C22014104100A2001411F6A20002D0087043A000020014120100141001002000B20004190066A240041030F0B20004190066A240041030F0B20004190066A240041030F0B4120100C22014104100A2001411F6A20002D00DF043A000020014120100141001002000B4120100C22014104100A200041E0046A20014120100F20014120100141001002000B20004190066A240041030F0B20004190066A240041030F0B4120100C22014104100A200041B0056A20014120100E20014120100141001002000B4120100C22014104100A2001411F6A20002D0087023A000020014120100141001002000B4120100C22014104100A2001411F6A20002D00C7033A000020014120100141001002000B0BCD06010041000BC606010000000000000082800000000000008A8000000000008000800080000000808B800000000000000100008000000000818000800000008009800000000000808A00000000000000880000000000000009800080000000000A000080000000008B800080000000008B0000000000008089800000000000800380000000000080028000000000008080000000000000800A800000000000000A0000800000008081800080000000808080000000000080010000800000000008800080000000800A000000070000000B0000001100000012000000030000000500000010000000080000001500000018000000040000000F00000017000000130000000D0000000C00000002000000140000000E000000160000000900000006000000010000000100000003000000060000000A0000000F000000150000001C000000240000002D00000037000000020000000E0000001B000000290000003800000008000000190000002B0000003E00000012000000270000003D000000140000002C00000045524332303A206275726E2066726F6D20746865207A65726F206164647265737300000000000000000000000000000045524332303A206275726E20616D6F756E7420657863656564732062616C616E6365000000000000000000000000000045524332303A206D696E7420746F20746865207A65726F20616464726573730045524332303A20617070726F76652066726F6D20746865207A65726F206164647265737300000000000000000000000045524332303A20617070726F766520746F20746865207A65726F2061646472657373000000000000000000000000000045524332303A2064656372656173656420616C6C6F77616E63652062656C6F77207A65726F000000000000000000000045524332303A207472616E7366657220616D6F756E74206578636565647320616C6C6F77616E6365000000000000000045524332303A207472616E736665722066726F6D20746865207A65726F2061646472657373000000000000000000000045524332303A207472616E7366657220746F20746865207A65726F20616464726573730000000000000000000000000045524332303A207472616E7366657220616D6F756E7420657863656564732062616C616E636500740970726F647563657273010C70726F6365737365642D62790105636C616E675431302E302E3120286769743A2F2F6769746875622E636F6D2F6C6C766D2F6C6C766D2D70726F6A65637420623661313733343336373838653638333239636335653965653066363531623630336136333765332900E005046E616D6501D8051D000C6C6F61645F73746F72616765010A7365745F72657475726E020B73797374656D5F68616C74030C736176655F73746F72616765040977726974655F6C6F67050A6765745F73656E64657206156765745F7472616E736665727265645F66756E6473070D6765745F63616C6C5F73697A65080F636F70795F63616C6C5F76616C756509085F5F6D656D6370790A085F5F627A65726F380B0B5F5F696E69745F686561700C085F5F6D616C6C6F630D0B5F5F62653332746F6C654E0E0B5F5F6C654E746F626533320F0A5F5F6C654E746F62654E100A766563746F725F6E6577110C736861335F6B656363616B66120473686133132C736F6C3A3A66756E6374696F6E3A3A45524332303A3A5F6275726E5F5F616464726573735F75696E74323536142C736F6C3A3A66756E6374696F6E3A3A45524332303A3A5F6D696E745F5F616464726573735F75696E743235361537736F6C3A3A66756E6374696F6E3A3A45524332303A3A5F617070726F76655F5F616464726573735F616464726573735F75696E743235361628736F6C3A3A66756E6374696F6E3A3A45524332303A3A62616C616E63654F665F5F616464726573731738736F6C3A3A66756E6374696F6E3A3A45524332303A3A696E637265617365416C6C6F77616E63655F5F616464726573735F75696E743235361838736F6C3A3A66756E6374696F6E3A3A45524332303A3A6465637265617365416C6C6F77616E63655F5F616464726573735F75696E74323536193B736F6C3A3A66756E6374696F6E3A3A45524332303A3A7472616E7366657246726F6D5F5F616464726573735F616464726573735F75696E743235361A38736F6C3A3A66756E6374696F6E3A3A45524332303A3A5F7472616E736665725F5F616464726573735F616464726573735F75696E743235361B30736F6C3A3A66756E6374696F6E3A3A45524332303A3A616C6C6F77616E63655F5F616464726573735F616464726573731C057374617274"
                    .HexToBytes()
            );
            if (!VirtualMachine.VerifyContract(contract.ByteCode))
                throw new Exception("Unable to validate smart-contract code");

            var snapshot = stateManager.NewSnapshot();
            snapshot.Contracts.AddContract(UInt160Utils.Zero, contract);
            stateManager.Approve();

            Console.WriteLine("Contract Hash: " + hash.ToHex());

            for (var i = 0; i < 1; ++i)
            {
                var currentTime = TimeUtils.CurrentTimeMillis();
                var currentSnapshot = stateManager.NewSnapshot();

                var sender = "0x6bc32575acb8754886dc283c2c8ac54b1bd93195".HexToBytes().ToUInt160();
                var to = "0xfd893ce89186fc6861d339cb6ab5d75458e3daf3".HexToBytes().ToUInt160();

                /* give to sender 1 token */
                var valueToTransfer = Money.Wei;
                stateManager.CurrentSnapshot.Storage.SetValue(contract.ContractAddress, sender.ToUInt256(),
                    (valueToTransfer * 3).ToUInt256());

                var transactionReceipt = new TransactionReceipt();
                transactionReceipt.Transaction = new Transaction();
                transactionReceipt.Transaction.Value = 0.ToUInt256();
                var context = new InvocationContext(sender, currentSnapshot, transactionReceipt);

                {
                    /* ERC-20: totalSupply (0x18160ddd) */
                    Console.WriteLine("\nERC-20: totalSupply()");
                    var input = ContractEncoder.Encode("totalSupply()");
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* mint */
                    Console.WriteLine($"\nERC-20: mint({sender.ToHex()},{Money.FromDecimal(100)})");
                    var input = ContractEncoder.Encode("mint(address,uint256)", sender, Money.FromDecimal(100));
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: totalSupply (0x18160ddd) */
                    Console.WriteLine("\nERC-20: totalSupply()");
                    var input = ContractEncoder.Encode("totalSupply()");
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({sender.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", sender);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: transfer */
                    Console.WriteLine($"\nERC-20: transfer({to.ToHex()},{Money.FromDecimal(50)})");
                    var input = ContractEncoder.Encode("transfer(address,uint256)", to, Money.FromDecimal(50));
                    Console.WriteLine($"ABI: {input.ToHex()}");
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({sender.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", sender);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({to.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", to);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: approve */
                    Console.WriteLine($"\nERC-20: approve({to.ToHex()},{Money.FromDecimal(50)})");
                    var input = ContractEncoder.Encode("approve(address,uint256)", to, Money.FromDecimal(50));
                    Console.WriteLine($"ABI: {input.ToHex()}");
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: transferFrom */
                    Console.WriteLine($"\nERC-20: transferFrom({to.ToHex()},{Money.FromDecimal(50)})");
                    var input = ContractEncoder.Encode("transferFrom(address,address,uint256)", sender, to,
                        Money.FromDecimal(50));
                    Console.WriteLine($"ABI: {input.ToHex()}");
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }

                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({sender.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", sender);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    /* ERC-20: balanceOf */
                    Console.WriteLine($"\nERC-20: balanceOf({to.ToHex()}");
                    var input = ContractEncoder.Encode("balanceOf(address)", to);
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }

                stateManager.Approve();
            exit_mark:
                var elapsedTime = TimeUtils.CurrentTimeMillis() - currentTime;
                Console.WriteLine("Elapsed Time: " + elapsedTime + "ms");
            }
        }
    }
}