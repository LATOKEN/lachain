using System;
using System.IO;
using System.Reflection;
using Lachain.Core.Blockchain.VM;
using Lachain.Core.CLI;
using Lachain.Core.Config;
using Lachain.Core.DI;
using Lachain.Core.DI.Modules;
using Lachain.Core.DI.SimpleInjector;
using Lachain.Proto;
using Lachain.Storage.State;
using Lachain.Utility;
using Lachain.Utility.Utils;
using Lachain.UtilityTest;
using NUnit.Framework;

namespace Lachain.CoreTest.IntegrationTests
{
    public class VirtualMachineTest
    {
        private IContainer _container;

        [SetUp]
        public void Setup()
        {
            TestUtils.DeleteTestChainData();

            var containerBuilder = new SimpleInjectorContainerBuilder(new ConfigManager(
                Path.Join(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), "config.json"),
                new RunOptions()
            ));

            containerBuilder.RegisterModule<BlockchainModule>();
            containerBuilder.RegisterModule<ConfigModule>();
            containerBuilder.RegisterModule<StorageModule>();

            _container = containerBuilder.Build();
        }

        [TearDown]
        public void Teardown()
        {
            _container.Dispose();

            TestUtils.DeleteTestChainData();
        }

        [Test]
        public void Test_VirtualMachine_InvokeContract()
        {
            var stateManager = _container.Resolve<IStateManager>();

            var hash = UInt160Utils.Zero;
            var contract = new Contract
            (
                hash,
                "0061736D0100000001410B60017F0060027F7F006000017F60037F7F7F0060000060017F017F60047F7E7E7F0060037F7F7F017F60047F7F7F7F017F60047E7E7E7E017F60037E7E7E017F02A1010803656E760A6765745F73656E646572000003656E760C6C6F61645F73746F72616765000103656E760C736176655F73746F72616765000103656E760A7365745F72657475726E000103656E760B73797374656D5F68616C74000003656E76156765745F7472616E736665727265645F66756E6473000003656E760D6765745F63616C6C5F73697A65000203656E760F636F70795F63616C6C5F76616C75650003030F0E0301040503030606070008090A040405017001010105030100020608017F01418080040B071202066D656D6F7279020005737461727400150AC62F0E2E0002402002450D000340200020012D00003A0000200041016A2100200141016A21012002417F6A22020D000B0B0B1C00034020004200370300200041086A21002001417F6A22010D000B0B2E004100410036028080044100410036028480044100410036028C800441003F0041107441F0FF7B6A36028880040BA60101047F418080042101024003400240200128020C0D002001280208220220004F0D020B200128020022010D000B41002101410028020821020B02402002200041076A41787122036B22024118490D00200120036A41106A22002001280200220436020002402004450D00200420003602040B2000200241706A3602082000410036020C2000200136020420012000360200200120033602080B2001410136020C200141106A0B2D002000411F6A21000340200120002D00003A0000200141016A21012000417F6A21002002417F6A22020D000B0B2D002001411F6A21010340200120002D00003A00002001417F6A2101200041016A21002002417F6A22020D000B0B5301017E02402003450D000240200341C00071450D0020012003413F71AD862102420021010C010B200141C00020036BAD8820022003AD220486842102200120048621010B20002002370308200020013703000B5301017E02402003450D000240200341C00071450D0020022003413F71AD882101420021020C010B200241C00020036BAD8620012003AD220488842101200220048821020B20002002370308200020013703000B7E01017F200120006C220141086A100B2203200036020420032000360200200341086A2100024002402002417F460D002001450D010340200020022D00003A0000200041016A2100200241016A21022001417F6A22010D000C020B0B2001450D000340200041003A0000200041016A21002001417F6A22010D000B0B20030BF30904117E017F067E027F20002903702101200029034821022000290368210320002903602104200029038001210520002903582106200029037821072000290350210820002903C0012109200029039801210A20002903B801210B200029039001210C20002903B001210D200029038801210E20002903A801210F20002903A0012110200029030021114100211203402000200029033022132000290308221485200685200585200F85220F42018920022000290320221585200185200A8520098522098522162010853703A0012000201620078537037820002016200885370350200020162000290328220A85370328200020162011853703002000200029033822172000290310221885200485200E85200D85220D420189200A20118520088520078520108522078522102005853703800120002010200685370358200020102013853703302000201020148522163703082000201020002903A801853703A8012000200029034022052000290318220685200385200C85200B852208420189200F85221020048537036020002010201785370338200020102018853703102000201020002903880185370388012000201020002903B001853703B00120002009420189200D85221020038537036820002010200585370340200020102006853703182000201020002903900185370390012000201020002903B801853703B80120002007420189200885221020018537037020002010200285370348200020102015853703202000201020002903980185370398012000201020002903C001853703C00141A07F211903402000201941A0026A2802004103746A221A2903002110201A201620194180036A3502008937030020102116201941046A22190D000B2000200029032022162000290308221020002903002201427F85838537032020002000290318220220012016427F85838537031820002000290310220320162002427F8583853703102000201020022003427F8583853703082000200120032010427F8583853703002000200029032822162000290338221020002903302201427F85838537032820002001200029034022022010427F85838537033020002010200029034822032002427F8583853703382000200220162003427F8583853703402000200320012016427F858385220237034820002903602116200029036821102000200029037022042000290358220520002903502207427F85838522013703702000201020072004427F85838522033703682000201620042010427F85838522043703602000200520102016427F85838522063703582000200720162005427F85838522083703502000290388012116200029039001211020002000290398012205200029038001220720002903782211427F858385220A370398012000201020112005427F858385220C370390012000201620052010427F858385220E370388012000200720102016427F8583852205370380012000201120162007427F858385220737037820002903B001211620002903B8012110200020002903C001221120002903A801221320002903A0012214427F85838522093703C0012000201020142011427F858385220B3703B8012000201620112010427F858385220D3703B0012000201320102016427F858385220F3703A8012000201420162013427F85838522103703A00120002000290300201241037441006A290300852211370300201241016A22124118470D000B0BC90301027F230041E0016B22042400200442003703C801200442003703C001200442003703B801200442003703B001200442003703A801200442003703A0012004420037039801200442003703900120044200370388012004420037038001200442003703782004420037037020044200370368200442003703602004420037035820044200370350200442003703482004420037034020044200370338200442003703302004420037032820044200370320200442003703182004420037031020044200370308200420033602D80141002105200441003602D001200441C80120034101746B3602D40102402001450D00410021050340200441086A20056A220320032D000020002D0000733A00000240200541016A220520042802D401480D00200441086A1011410021050B200041016A21002001417F6A22010D000B0B200420053602D001200441086A20056A220520052D00004106733A000020042802D401200441086A6A417F6A220520052D0000418001733A0000200441086A1011024020042802D80122014101480D00200441086A2105200221000340200020052D00003A0000200541016A2105200041016A21002001417F6A22010D000B0B200441E0016A240020020B93110A027F037E017F027E017F017E017F017E037F037E23004180026B220424002004220541E8016A1000200541E8016A41106A3502002106200541E8016A41086A290300210720052903E8012108200441406A220422092400200441286A2007370300200441206A2008370300200441306A20063E0200200441186A420037030020044200370310200442003703082004420137030020044138200541C8016A412010121A200541A8016A41186A200541C8016A41186A290300220A3703002005200541C8016A41106A29030022073703B8012005200541C8016A41086A29030022083703B001200520052903C80122063703A801200541A8016A20054188016A1001024002400240024020052903880120054188016A41106A2903008420054188016A41086A29030020054188016A41186A2903008484500D00200941606A22042209240020042008200642017C220B200654220CAD7C220D3703082004200B37030020042007200C200D200854200B20065A1BAD7C220B370310200441186A200A200B200754AD7C370300200941606A2209220C240020042009100120092D00000D01200C41606A22042209240020042008200642017C220B200654220CAD7C220D3703082004200B37030020042007200C200D200854200B20065A1BAD7C220B370310200441186A200A200B200754AD7C370300200941706A220C22092400200C41013A0000200941606A2209220E24002009410410092009200C2D00004101713A0000200420091002200E41606A220422092400200441186A200A2007200642037C220B200654220C2008200CAD7C220D200854200B20065A1BAD7C220F200754AD7C3703002004200F3703102004200D3703082004200B370300200941606A2209220C2400200941186A2003370300200920023703102009200137030820092000370300200420091002200C41606A220422092400200441186A4200370300200442003703102004420037030820044202370300200941606A2209220C2400200420091001200020092903005A2001200941086A290300220B5A2001200B511B2002200941106A290300220D5A2003200941186A290300220B5A2003200B511B2002200D852003200B8584501B0D02200C41606A220422092400200441186A4200370300200442003703102004420037030820044202370300200941606A2209220C240020042009100120002009290300542001200941086A290300220B542001200B511B2002200941106A290300220B542003200941186A29030022015420032001511B2002200B85200320018584501B450D03200C41606A220422092400200441186A4200370300200442003703102004420037030820044202370300200941606A2209220C2400200441202009412010121A200541E8006A20092903002203200941086A29030022012000A74102742204100E200541C8006A2003200141800120046B2210100F200541F8006A200941106A2903002202200941186A29030022002004100E200541D8006A20032001200441807F6A2211100E20052903682103200C41606A220C220E2400200C2003420020044180014922091B220342017C2201370300200C200541E8006A41086A290300420020091B220B20012003542212AD7C220D370308200C2005290378200529034884200529035820091B200220041B22022012200D200B54200120035A1BAD7C2203370310200C41186A200541F8006A41086A290300200541C8006A41086A29030084200541D8006A41086A29030020091B200020041B2003200254AD7C370300200E41606A220E22122400200C200E1001200E41186A2903002100200E41106A2903002101200E2903002102200E41086A2903002103201241606A220C220E2400200C41186A200A370300200C2007370310200C2008370308200C2006370300200E41606A220E22122400200C200E1001200E41186A2903002108200E41106A290300210A200E290300210B200E41086A290300210D201241606A220C220E2400200C41186A4200370300200C4200370310200C4200370308200C4202370300200E41606A220E22122400200C4120200E412010121A200541286A200E2903002206200E41086A29030022072004100E200541186A200620072010100F200541386A200E41106A290300220F200E41186A29030022132004100E200541086A200620072011100E20052903282106201241606A220C220E2400200C2006420020091B220642017C2207370300200C200541286A41086A290300420020091B221420072006542210AD7C2215370308200C2005290338200529031884200529030820091B200F20041B220F20102015201454200720065A1BAD7C2206370310200C41186A200541386A41086A290300200541186A41086A29030084200541086A41086A29030020091B201320041B2006200F54AD7C370300200E41606A22042400200441186A200020087C2001200A7C2206200154AD7C20062002200B7C220820025422092003200D7C2009AD7C220720035420072003511BAD7C2203200654AD7C370300200420033703102004200737030820042008370300200C2004100220054180026A240041000F0B4114410141800310102204280200413F6A41607141246A220C100B220541A0F38DC600360200200541046A220E200C4103761009200941706A220922102400200941203602002009200E4104100D20042802002109201041706A220E2400200E2009360200200E200541246A4104100D200541C4006A200441086A200910082005200C100341011004000B410E410141940310102204280200413F6A41607141246A2209100B220541A0F38DC600360200200541046A220E20094103761009200C41706A220C22102400200C4120360200200C200E4104100D2004280200210C201041706A220E2400200E200C360200200E200541246A4104100D200541C4006A200441086A200C100820052009100341011004000B41004100100341011004000B41004100100341011004000BF70805027F037E027F037E027F230041E0006B220324002003220441C8006A1000200441286A41186A4200370300200442003703382004420037033020044200370328200441C8006A41086A2903002105200441C8006A41106A350200210620042903482107200441286A200441086A100102400240024020072004290308852006200441086A41106A35020085842005200441086A41086A29030085844200520D00200341406A220322082400200341286A2001370300200341206A2000370300200341306A20023E0200200341186A4200370300200342003703102003420037030820034201370300200841606A220822092400200341382008412010121A20082903002105200841086A2903002106200841186A290300210A200841106A2903002107200941606A22032208240020032006200542017C220B2005542209AD7C220C3703082003200B370300200320072009200C200654200B20055A1BAD7C2205370310200341186A200A2005200754AD7C370300200841606A22082209240020032008100120082D00000D01200941406A220322082400200341286A2001370300200341206A2000370300200341306A20023E0200200341186A4200370300200342003703102003420037030820034201370300200841606A220822092400200341382008412010121A20082903002105200841086A2903002106200841106A2903002107200841186A290300210B200941606A220322082400200341186A200B370300200320073703102003200637030820032005370300200841606A2208220924002003200810012008290300200841106A29030084200841086A290300200841186A2903008484500D0241004100100341011004000B4128410141B00310102208280200413F6A41607141246A2209100B220441A0F38DC600360200200441046A220D20094103761009200341706A2203220E2400200341203602002003200D4104100D20082802002103200E41706A220D2400200D2003360200200D200441246A4104100D200441C4006A200841086A2003100820042009100341011004000B4118410141E00310102203280200413F6A41607141246A2208100B220441A0F38DC600360200200441046A220D20084103761009200941706A2209220E2400200941203602002009200D4104100D20032802002109200E41706A220D2400200D2009360200200D200441246A4104100D200441C4006A200341086A2009100820042008100341011004000B200941406A220322082400200341286A2001370300200341206A2000370300200341306A20023E0200200341186A4200370300200342003703102003420037030820034201370300200841606A220822092400200341382008412010121A20082903002100200841086A2903002101200841106A2903002102200841186A2903002105200941606A220322082400200341186A2005370300200320023703102003200137030820032000370300200841606A22082400200841186A4200370300200842003703102008420037030820084201370300200320081002200441E0006A240041000BCF0201047F230041D0006B22002400200041086A10050240024002400240024002402000290308200041106A290300844200520D00100A4100100622013602FC0341002001100B2202360280044100200120021007200141034D0D014100200228020022033602F8032001417C6A2101200241046A210202402003419EF7B58C06460D0020034181C2E4FD03470D0220014120490D032002200041186A4120100C2000290318200041206A290300200041286A290300200041306A2903001013450D0441004100100341011004000B20014120490D042002200041386A4118100C2000290338200041C0006A290300200041C8006A3502001014450D0541004100100341011004000B41004100100341011004000B41004100100341011004000B200041D0006A240041030F0B41004100100341001004000B200041D0006A240041030F0B41004100100341001004000B0BFF03010041000BF803010000000000000082800000000000008A8000000000008000800080000000808B800000000000000100008000000000818000800000008009800000000000808A00000000000000880000000000000009800080000000000A000080000000008B800080000000008B0000000000008089800000000000800380000000000080028000000000008080000000000000800A800000000000000A0000800000008081800080000000808080000000000080010000800000000008800080000000800A000000070000000B0000001100000012000000030000000500000010000000080000001500000018000000040000000F00000017000000130000000D0000000C00000002000000140000000E000000160000000900000006000000010000000100000003000000060000000A0000000F000000150000001C000000240000002D00000037000000020000000E0000001B000000290000003800000008000000190000002B0000003E00000012000000270000003D000000140000002C000000486173206E6F20726967687420746F20766F7465416C726561647920766F7465642E00000000000000000000000000004F6E6C79206368616972706572736F6E2063616E206769766520726967687420746F20766F74652E000000000000000054686520766F74657220616C726561647920766F7465642E00740970726F647563657273010C70726F6365737365642D62790105636C616E675431302E302E3120286769743A2F2F6769746875622E636F6D2F6C6C766D2F6C6C766D2D70726F6A65637420623661313733343336373838653638333239636335653965653066363531623630336136333765332900DA02046E616D6501D20216000A6765745F73656E646572010C6C6F61645F73746F72616765020C736176655F73746F72616765030A7365745F72657475726E040B73797374656D5F68616C7405156765745F7472616E736665727265645F66756E6473060D6765745F63616C6C5F73697A65070F636F70795F63616C6C5F76616C756508085F5F6D656D63707909085F5F627A65726F380A0B5F5F696E69745F686561700B085F5F6D616C6C6F630C0B5F5F62653332746F6C654E0D0B5F5F6C654E746F626533320E095F5F6173686C7469330F095F5F6C736872746933100A766563746F725F6E6577110C736861335F6B656363616B661204736861331324736F6C3A3A66756E6374696F6E3A3A42616C6C6F743A3A766F74655F5F75696E74323536142F736F6C3A3A66756E6374696F6E3A3A42616C6C6F743A3A676976655269676874546F566F74655F5F6164647265737315057374617274"
                    .HexToBytes()
            );
            if (!VirtualMachine.VerifyContract(contract.ByteCode))
                throw new Exception("Unable to validate smart-contract code");

            var snapshot = stateManager.NewSnapshot();
            snapshot.Contracts.AddContract(UInt160Utils.Zero, contract);
            stateManager.Approve();


            Console.WriteLine("Contract Hash: " + hash.ToHex());

            for (var i = 0; i < 1; ++i)
            {
                var currentTime = TimeUtils.CurrentTimeMillis();
                var currentSnapshot = stateManager.NewSnapshot();

                var sender = "0x6bc32575acb8754886dc283c2c8ac54b1bd93195".HexToBytes().ToUInt160();

                var valueToTransfer = Money.Wei;
                stateManager.CurrentSnapshot.Storage.SetValue(contract.ContractAddress, sender.ToUInt256(), (valueToTransfer * 3).ToUInt256());

                var transactionReceipt = new TransactionReceipt();
                transactionReceipt.Transaction = new Transaction();
                transactionReceipt.Transaction.Value = 0.ToUInt256();
                var context = new InvocationContext(sender, currentSnapshot, transactionReceipt);

                {
                    Console.WriteLine($"\nBallot: vote(0)");
                    var input = ContractEncoder.Encode("vote(uint)", 0.ToUInt256());
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }
                {
                    Console.WriteLine("\nBallot: winningProposal()");
                    var input = ContractEncoder.Encode("winningProposal()");
                    Console.WriteLine("ABI: " + input.ToHex());
                    var status = VirtualMachine.InvokeWasmContract(contract, context, input, 100_000_000_000_000UL);
                    if (status.Status != ExecutionStatus.Ok)
                    {
                        stateManager.Rollback();
                        Console.WriteLine("Contract execution failed: " + status.Status);
                        Console.WriteLine($"Result: {status.ReturnValue?.ToHex()}");
                        goto exit_mark;
                    }

                    Console.WriteLine($"Result: {status.ReturnValue!.ToHex()}");
                }

                stateManager.Approve();
                exit_mark:
                var elapsedTime = TimeUtils.CurrentTimeMillis() - currentTime;
                Console.WriteLine("Elapsed Time: " + elapsedTime + "ms");
            }
        }
    }
}